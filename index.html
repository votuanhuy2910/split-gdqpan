<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Ứng dụng Chia đợt Sinh viên học Giáo dục Quốc phòng - An ninh
        </title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body class="bg-gray-100 p-8">
        <div
            id="loadingOverlay"
            class="fixed inset-0 bg-gray-800 bg-opacity-50 flex flex-col items-center justify-center z-50 hidden"
        >
            <div class="loader mb-4"></div>
            <p id="progressText" class="text-lg font-semibold text-black">
                Đang xử lý... 0%
            </p>
        </div>

        <div class="container mx-auto space-y-8">
            <!-- HEADER -->
            <header class="text-center">
                <h1 class="text-4xl font-bold text-gray-800">
                    Ứng dụng Chia đợt Sinh viên học Giáo dục Quốc phòng - An
                    ninh
                </h1>
                <p class="text-gray-600 mt-2">
                    Quản lý và phân chia sinh viên theo khoa/viện
                </p>
            </header>

            <!-- INPUT SECTION -->
            <div class="card grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Nhập thông tin thủ công -->
                <div class="md:col-span-1">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">
                        Nhập thông tin Khoa/Viện
                    </h2>
                    <div class="flex items-start flex-col space-y-4">
                        <div class="input-group flex-grow">
                            <label for="universityName" class="block text-sm"
                                >Trường thành viên</label
                            >
                            <select
                                id="universityName"
                                class="mt-1 block w-full border border-gray-300 rounded-lg p-2"
                            >
                                <option value="" disabled selected>
                                    Chọn Trường
                                </option>
                                <option value="COB">COB</option>
                                <option value="CELG">CELG</option>
                                <option value="CTD">CTD</option>
                            </select>
                        </div>
                        <div class="input-group flex-grow">
                            <label for="departmentName" class="block text-sm"
                                >Khoa/Viện</label
                            >
                            <select
                                id="departmentName"
                                class="mt-1 block w-full border border-gray-300 rounded-lg p-2"
                            >
                                <option value="" disabled selected>
                                    Chọn Khoa/Viện
                                </option>
                                <option
                                    value="Khoa Công nghệ thông tin kinh doanh"
                                >
                                    Khoa Công nghệ thông tin kinh doanh
                                </option>
                                <option value="Khoa Luật">Khoa Luật</option>
                                <option value="Khoa KDQT">Khoa KDQT</option>
                                <option value="Khoa Kế toán">
                                    Khoa Kế toán
                                </option>
                                <option value="Khoa Tài chính">
                                    Khoa Tài chính
                                </option>
                                <option
                                    value="Viện Công nghệ thông minh và tương tác"
                                >
                                    Viện Công nghệ thông minh và tương tác
                                </option>
                            </select>
                        </div>
                        <div class="input-group flex-grow">
                            <label for="studentCount" class="block text-sm"
                                >Số lượng sinh viên</label
                            >
                            <input
                                type="number"
                                id="studentCount"
                                placeholder="Số lượng"
                                class="mt-1 block w-full"
                            />
                        </div>
                        <button
                            id="addDepartment"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                        >
                            Thêm
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        Nhập từng Khoa/Viện một cách thủ công
                    </p>
                </div>

                <!-- Nhập thông tin bằng file Excel -->
                <div class="md:col-span-1">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">
                        Nhập từ tệp Excel
                    </h2>
                    <div class="flex items-end space-x-4">
                        <div class="input-group flex-grow">
                            <label for="excelFile" class="block text-sm"
                                >Chọn tệp (.xlsx ; .xls)</label
                            >
                            <input
                                type="file"
                                id="excelFile"
                                accept=".xlsx, .xls"
                                class="mt-1 block w-full"
                            />
                        </div>
                        <button
                            id="importExcel"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                        >
                            Import
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        Tệp Excel phải có 3 cột: Trường thành viên, Khoa/Viện và
                        Số lượng
                    </p>
                </div>

                <!-- Chia đợt -->
                <div class="md:col-span-1">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">
                        Thiết lập Chia đợt
                    </h2>
                    <div id="minMaxInputs" class="space-y-4">
                        <!-- Dynamic inputs for min/max values for each batch -->
                        <div class="flex items-center space-x-4">
                            <div class="flex-grow">
                                <label
                                    class="block text-sm font-medium text-gray-700"
                                    >Đợt 1</label
                                >
                                <input
                                    type="number"
                                    id="min1"
                                    placeholder="Min"
                                    class="mt-1 w-full"
                                    value="0"
                                />
                            </div>
                            <div class="flex-grow">
                                <label
                                    class="block text-sm font-medium text-gray-700"
                                    >&nbsp;</label
                                >
                                <input
                                    type="number"
                                    id="max1"
                                    placeholder="Max"
                                    class="mt-1 w-full"
                                    value="3600"
                                />
                            </div>
                        </div>
                        <!-- You can add more batches here manually, or dynamically with JS -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button
                            id="addBatch"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg text-sm"
                        >
                            + Thêm đợt
                        </button>
                    </div>
                </div>
            </div>

            <!-- MAIN CONTENT - Bảng thông tin & Button Generate -->
            <div class="card grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">
                        Bảng thông tin Sinh viên
                    </h2>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm font-medium text-gray-700">
                            Tổng số sinh viên:
                            <span id="totalStudents" class="font-bold text-lg"
                                >0</span
                            >
                        </p>
                        <p class="text-sm text-gray-500">
                            Nhấp vào số lượng để sửa
                        </p>
                    </div>
                    <div class="table-container">
                        <table
                            class="min-w-full bg-white rounded-lg overflow-hidden"
                        >
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-left">STT</th>
                                    <th class="py-3 px-4 text-left">
                                        Trường thành viên
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Khoa/Viện
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Số lượng sinh viên
                                    </th>
                                    <th class="py-3 px-4 text-left">
                                        Hành động
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div
                    class="md:col-span-1 flex flex-col items-center justify-start"
                >
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">
                            Phương thức chia đợt:
                        </h3>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    name="generationMode"
                                    value="department"
                                    class="form-radio"
                                    checked
                                />
                                <span class="ml-2 text-sm text-gray-700"
                                    >Theo Khoa/Viện</span
                                >
                            </label>
                            <label class="flex items-center">
                                <input
                                    type="radio"
                                    name="generationMode"
                                    value="university"
                                    class="form-radio"
                                />
                                <span class="ml-2 text-sm text-gray-700"
                                    >Theo Trường thành viên</span
                                >
                            </label>
                        </div>
                    </div>
                    <button
                        id="generateButton"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg transform transition-all duration-300 hover:scale-105"
                    >
                        Generate
                    </button>
                </div>
            </div>

            <!-- RESULT SECTION -->
            <div
                id="resultsSection"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
                style="display: none"
            >
                <h2
                    class="col-span-full text-2xl font-bold text-gray-800 text-center mt-4"
                >
                    Kết quả Chia đợt
                </h2>
                <!-- Generated tables will be inserted here -->
            </div>

            <div class="md:col-span-1 flex items-center justify-center">
                <button
                    id="exportExcelButton"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full text-lg shadow-lg transform transition-all duration-300 hover:scale-105"
                    style="display: none"
                >
                    Xuất Excel
                </button>
            </div>
        </div>

        <!-- For Excel import functionality -->
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const universityNameInput =
                    document.getElementById("universityName");
                const departmentNameInput =
                    document.getElementById("departmentName");
                const studentCountInput =
                    document.getElementById("studentCount");
                const addDepartmentBtn =
                    document.getElementById("addDepartment");
                const excelFileInput = document.getElementById("excelFile");
                const importExcelBtn = document.getElementById("importExcel");
                const minMaxInputsContainer =
                    document.getElementById("minMaxInputs");
                const addBatchBtn = document.getElementById("addBatch");
                const dataTableBody = document.getElementById("dataTableBody");
                const generateButton =
                    document.getElementById("generateButton");
                const resultsSection =
                    document.getElementById("resultsSection");
                const totalStudentsDisplay =
                    document.getElementById("totalStudents");
                const exportExcelButton =
                    document.getElementById("exportExcelButton");
                const generationModeInputs =
                    document.getElementsByName("generationMode");

                let studentData = [];
                let batches = [];
                let batchCount = 1;

                // Function to calculate and display the total student count
                const updateTotalStudents = () => {
                    const total = studentData.reduce(
                        (sum, current) => sum + current.count,
                        0
                    );
                    totalStudentsDisplay.textContent = total;
                };

                // Function to render the main data table
                const renderDataTable = () => {
                    dataTableBody.innerHTML = "";
                    studentData.forEach((item, index) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.university || "N/A"}</td>
                        <td>${item.department}</td>
                        <td>
                            <input type="number" value="${
                                item.count
                            }" class="w-24 bg-transparent border-none text-center" data-index="${index}">
                        </td>
                        <td>
                            <button class="text-red-500 hover:text-red-700 hover:scale-105 p-3" data-index="${index}">Xóa</button>
                        </td>
                    `;
                        dataTableBody.appendChild(row);
                    });
                    updateTotalStudents();
                };

                // Function to render a single batch result table
                const renderBatchTable = (batch, index, mode) => {
                    let mainHeader, subHeader;
                    if (mode === "university") {
                        mainHeader = "Trường thành viên";
                        subHeader = "Khoa/Viện";
                    } else {
                        mainHeader = "Khoa/Viện";
                        subHeader = "Trường thành viên";
                    }

                    return `
                        <div class="card" id="batch-results-${index}">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Kết quả Đợt ${
                                index + 1
                            }</h3>
                            <p class="text-sm font-medium text-gray-700">Tổng số sinh viên: <span class="font-bold">${
                                batch.currentTotal
                            }</span></p>
                            <div class="table-container mt-2">
                                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                    <thead>
                                        <tr>
                                            <th class="py-3 px-4 text-left">${mainHeader}</th>
                                            <th class="py-3 px-4 text-left">${subHeader}</th>
                                            <th class="py-3 px-4 text-left">Số lượng sinh viên</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${batch.data
                                            .map(
                                                (item, itemIndex) => `
                                            <tr draggable="true" class="draggable-row" data-university="${item.university}" data-department="${item.department}" data-count="${item.count}" data-source-batch-index="${index}" data-source-item-index="${itemIndex}">
                                                <td>${item.university}</td>
                                                <td>${item.department}</td>
                                                <td>${item.count}</td>
                                            </tr>
                                        `
                                            )
                                            .join("")}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                };

                // Function to render all batch result tables
                const renderResults = (batches, unassignedStudents, mode) => {
                    resultsSection.innerHTML = "";
                    resultsSection.style.display = "grid";

                    if (batches.length > 0) {
                        batches.forEach((batch, index) => {
                            const batchTableHTML = renderBatchTable(
                                batch,
                                index,
                                mode
                            );
                            resultsSection.insertAdjacentHTML(
                                "beforeend",
                                batchTableHTML
                            );
                        });
                    }

                    if (unassignedStudents.length > 0) {
                        const unassignedDiv = document.createElement("div");
                        unassignedDiv.className = "card col-span-full mt-8";
                        unassignedDiv.innerHTML = `
                            <h3 class="text-xl font-semibold text-red-700 mb-4">Các Khoa/Viện không thể phân bổ</h3>
                            <p class="text-red-500">Các khoa/viện dưới đây có số lượng sinh viên vượt quá khả năng chứa của các đợt đã thiết lập:</p>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                ${unassignedStudents
                                    .map(
                                        (s) =>
                                            `<li>${s.university} - ${s.department} (${s.count} sinh viên)</li>`
                                    )
                                    .join("")}
                            </ul>
                        `;
                        resultsSection.appendChild(unassignedDiv);
                    }
                };

                // Hàm xuất file Excel
                const exportToExcel = (batches, unassignedStudents) => {
                    const workbook = XLSX.utils.book_new();

                    // Gộp dữ liệu của tất cả các đợt vào một mảng
                    const combinedData = [];
                    batches.forEach((batch, index) => {
                        batch.data.forEach((item) => {
                            combinedData.push({
                                Đợt: `Đợt ${index + 1}`,
                                "Trường thành viên": item.university,
                                "Khoa/Viện": item.department,
                                "Số lượng sinh viên": item.count,
                            });
                        });
                    });

                    // Thêm dữ liệu không phân bổ (nếu có)
                    if (unassignedStudents.length > 0) {
                        unassignedStudents.forEach((item) => {
                            combinedData.push({
                                Đợt: "Không phân bổ",
                                "Trường thành viên": item.university,
                                "Khoa/Viện": item.department,
                                "Số lượng sinh viên": item.count,
                            });
                        });
                    }

                    // Tạo sheet từ dữ liệu gộp
                    const worksheet = XLSX.utils.json_to_sheet(combinedData);
                    XLSX.utils.book_append_sheet(
                        workbook,
                        worksheet,
                        "Kết quả Chia đợt"
                    );

                    // Xuất file Excel
                    XLSX.writeFile(
                        workbook,
                        "KetQuaChiaDotHocGDQP-AN_K51.xlsx"
                    );
                };

                // Add department manually
                addDepartmentBtn.addEventListener("click", () => {
                    const university = universityNameInput.value.trim();
                    const name = departmentNameInput.value.trim();
                    const count = parseInt(studentCountInput.value, 10);

                    if (university && name && !isNaN(count) && count > 0) {
                        studentData.push({
                            university: university,
                            department: name,
                            count: count,
                        });
                        renderDataTable();
                        universityNameInput.value = "";
                        departmentNameInput.value = "";
                        studentCountInput.value = "";
                    } else {
                        alert(
                            "Vui lòng nhập đầy đủ Trường thành viên, Khoa/Viện và số lượng hợp lệ."
                        );
                    }
                });

                // Handle changes in the student count input fields
                dataTableBody.addEventListener("change", (event) => {
                    if (
                        event.target.tagName === "INPUT" &&
                        event.target.type === "number"
                    ) {
                        const index = event.target.dataset.index;
                        const newCount = parseInt(event.target.value, 10);
                        if (!isNaN(newCount) && newCount >= 0) {
                            studentData[index].count = newCount;
                            updateTotalStudents();
                        } else {
                            alert("Số lượng không hợp lệ.");
                            event.target.value = studentData[index].count; // Revert to old value
                        }
                    }
                });

                // Handle delete button click
                dataTableBody.addEventListener("click", (event) => {
                    if (
                        event.target.tagName === "BUTTON" &&
                        event.target.textContent === "Xóa"
                    ) {
                        const index = event.target.dataset.index;
                        studentData.splice(index, 1);
                        renderDataTable();
                    }
                });

                // Import from Excel
                importExcelBtn.addEventListener("click", () => {
                    const file = excelFileInput.files[0];
                    if (!file) {
                        alert("Vui lòng chọn một tệp Excel để import.");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: "array" });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        // Map the data to the correct format, assuming column headers "Trường thành viên", "Khoa/Viện" and "Số lượng"
                        studentData = json
                            .map((row) => ({
                                university: row["Trường thành viên"],
                                department: row["Khoa/Viện"],
                                count: parseInt(row["Số lượng"], 10),
                            }))
                            .filter(
                                (item) => item.department && !isNaN(item.count)
                            );

                        renderDataTable();
                    };
                    reader.readAsArrayBuffer(file);
                });

                // Add a new batch input field
                addBatchBtn.addEventListener("click", () => {
                    batchCount++;
                    const newBatchInput = document.createElement("div");
                    newBatchInput.className =
                        "flex items-center space-x-4 batch-row";
                    newBatchInput.setAttribute("data-batch-id", batchCount);
                    newBatchInput.innerHTML = `
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">Đợt ${batchCount}</label>
                            <input type="number" id="min${batchCount}" placeholder="Min" class="mt-1 w-full" value="0">
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">&nbsp;</label>
                            <input type="number" id="max${batchCount}" placeholder="Max" class="mt-1 w-full" value="3600">
                        </div>
                        <button class="remove-batch bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                            Xóa
                        </button>
                    `;
                    minMaxInputsContainer.appendChild(newBatchInput);
                });

                // Handle batch removal
                minMaxInputsContainer.addEventListener("click", (event) => {
                    if (event.target.classList.contains("remove-batch")) {
                        const batchRow = event.target.closest(".batch-row");
                        if (batchRow) {
                            batchRow.remove();
                        }
                    }
                });

                // Hiển thị nút Xuất Excel sau khi Generate và Loading hoàn tất
                generateButton.addEventListener("click", () => {
                    if (studentData.length === 0) {
                        alert("Vui lòng nhập dữ liệu sinh viên trước khi tạo.");
                        return;
                    }

                    const selectedMode = document.querySelector(
                        'input[name="generationMode"]:checked'
                    ).value;

                    // Hiển thị overlay loading
                    const loadingOverlay =
                        document.getElementById("loadingOverlay");
                    const progressText =
                        document.getElementById("progressText");

                    loadingOverlay.classList.remove("hidden");
                    progressText.textContent = "Đang xử lý... 0%";

                    let progress = 0;

                    // Hàm mô phỏng tiến trình loading
                    const simulateLoading = setInterval(() => {
                        progress += 5; // Tăng tiến trình mỗi lần chạy
                        progressText.textContent = `Đang xử lý... ${progress}%`;

                        if (progress >= 100) {
                            clearInterval(simulateLoading); // Dừng tiến trình khi đạt 100%
                            loadingOverlay.classList.add("hidden"); // Ẩn overlay loading

                            // Thực hiện logic generate sau khi loading hoàn tất
                            generateResults(selectedMode);
                        }
                    }, 100); // Cập nhật mỗi 100ms
                });

                // Fisher-Yates shuffle algorithm to randomize the array
                const shuffleArray = (array) => {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                };

                // Hàm thực hiện logic generate
                const generateResults = (mode) => {
                    batches = [];
                    for (let i = 1; i <= batchCount; i++) {
                        const min = parseInt(
                            document.getElementById(`min${i}`).value,
                            10
                        );
                        const max = parseInt(
                            document.getElementById(`max${i}`).value,
                            10
                        );
                        if (isNaN(min) || isNaN(max) || min > max) {
                            alert(`Dữ liệu Min/Max của Đợt ${i} không hợp lệ.`);
                            return;
                        }
                        batches.push({ min, max, currentTotal: 0, data: [] });
                    }

                    let studentsToAssign = JSON.parse(
                        JSON.stringify(studentData)
                    );

                    // Luôn ưu tiên Khoa "Viện Công nghệ thông minh và tương tác" của "CTD"
                    const priorityIndex = studentsToAssign.findIndex(
                        (s) =>
                            s.university === "CTD" &&
                            s.department ===
                                "Viện Công nghệ thông minh và tương tác"
                    );

                    if (priorityIndex > -1) {
                        const [priorityStudent] = studentsToAssign.splice(
                            priorityIndex,
                            1
                        );
                        if (
                            batches[0].currentTotal + priorityStudent.count <=
                            batches[0].max
                        ) {
                            batches[0].data.push(priorityStudent);
                            batches[0].currentTotal += priorityStudent.count;
                        } else {
                            // Nếu không đủ chỗ ở đợt 1, thêm lại vào đầu danh sách để xử lý sau
                            studentsToAssign.unshift(priorityStudent);
                        }
                    }

                    // Sắp xếp các sinh viên còn lại dựa trên chế độ đã chọn
                    if (mode === "university") {
                        studentsToAssign = shuffleArray(studentsToAssign);
                        studentsToAssign.sort((a, b) =>
                            a.university.localeCompare(b.university)
                        );
                    } else {
                        // mode === 'department'
                        studentsToAssign = shuffleArray(studentsToAssign);
                    }

                    const unassignedStudents = [];

                    // Sắp xếp sinh viên còn lại theo số lượng, từ lớn nhất đến nhỏ nhất
                    studentsToAssign.sort((a, b) => b.count - a.count);

                    studentsToAssign.forEach((student) => {
                        let assigned = false;
                        for (let i = 0; i < batches.length; i++) {
                            const batch = batches[i];
                            if (
                                batch.currentTotal + student.count <=
                                batch.max
                            ) {
                                batch.data.push({
                                    university: student.university,
                                    department: student.department,
                                    count: student.count,
                                });
                                batch.currentTotal += student.count;
                                assigned = true;
                                break; // Chuyển sang sinh viên tiếp theo
                            }
                        }
                        if (!assigned) {
                            unassignedStudents.push(student);
                        }
                    });

                    renderResults(batches, unassignedStudents, mode);

                    // Hiển thị nút Xuất Excel
                    exportExcelButton.style.display = "block";

                    // Gắn sự kiện cho nút Xuất Excel
                    exportExcelButton.onclick = () =>
                        exportToExcel(batches, unassignedStudents);
                };

                // Drag and Drop Logic
                let draggedItem = null;

                resultsSection.addEventListener("dragstart", (e) => {
                    if (
                        e.target.tagName === "TR" &&
                        e.target.classList.contains("draggable-row")
                    ) {
                        draggedItem = e.target;
                        e.dataTransfer.setData(
                            "text/plain",
                            JSON.stringify({
                                university: draggedItem.dataset.university,
                                department: draggedItem.dataset.department,
                                count: parseInt(draggedItem.dataset.count, 10),
                                sourceBatchIndex: parseInt(
                                    draggedItem.dataset.sourceBatchIndex,
                                    10
                                ),
                                sourceItemIndex: parseInt(
                                    draggedItem.dataset.sourceItemIndex,
                                    10
                                ),
                            })
                        );
                        e.dataTransfer.effectAllowed = "move";
                    }
                });

                resultsSection.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    const dropTarget = e.target.closest(".card");
                    if (
                        dropTarget &&
                        dropTarget.id.startsWith("batch-results-")
                    ) {
                        dropTarget.classList.add("drag-over");
                    }
                });

                resultsSection.addEventListener("dragleave", (e) => {
                    const dropTarget = e.target.closest(".card");
                    if (dropTarget) {
                        dropTarget.classList.remove("drag-over");
                    }
                });

                resultsSection.addEventListener("drop", (e) => {
                    e.preventDefault();
                    const dropTarget = e.target.closest(".card");
                    if (
                        !dropTarget ||
                        !dropTarget.id.startsWith("batch-results-")
                    ) {
                        return;
                    }

                    dropTarget.classList.remove("drag-over");

                    if (draggedItem) {
                        try {
                            const droppedData = JSON.parse(
                                e.dataTransfer.getData("text/plain")
                            );
                            const sourceBatchIndex =
                                droppedData.sourceBatchIndex;
                            const destinationBatchIndex = parseInt(
                                dropTarget.id.split("-")[2],
                                10
                            );

                            // Check if the item can be added to the destination batch
                            const destinationBatch =
                                batches[destinationBatchIndex];
                            if (
                                destinationBatch.currentTotal +
                                    droppedData.count >
                                destinationBatch.max
                            ) {
                                const message = `Không thể di chuyển '${
                                    droppedData.department
                                }' vì sẽ vượt quá giới hạn tối đa (${
                                    destinationBatch.max
                                }) của Đợt ${destinationBatchIndex + 1}.`;
                                const messageBox =
                                    document.createElement("div");
                                messageBox.className =
                                    "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 shadow-xl z-50 text-center";
                                messageBox.innerHTML = `
                                    <p class="text-red-500 font-semibold mb-4">${message}</p>
                                    <button class="bg-blue-500 text-white py-2 px-4 rounded-lg" onclick="this.parentElement.remove()">Đóng</button>
                                `;
                                document.body.appendChild(messageBox);
                                return;
                            }

                            // Remove from source batch
                            const sourceBatch = batches[sourceBatchIndex];
                            const itemIndex = sourceBatch.data.findIndex(
                                (item) =>
                                    item.department ===
                                        droppedData.department &&
                                    item.count === droppedData.count
                            );
                            if (itemIndex > -1) {
                                const [movedItem] = sourceBatch.data.splice(
                                    itemIndex,
                                    1
                                );
                                sourceBatch.currentTotal -= movedItem.count;
                            }

                            // Add to destination batch
                            destinationBatch.data.push({
                                university: droppedData.university,
                                department: droppedData.department,
                                count: droppedData.count,
                            });
                            destinationBatch.currentTotal += droppedData.count;

                            // Re-render both affected batches
                            const selectedMode = document.querySelector(
                                'input[name="generationMode"]:checked'
                            ).value;
                            renderResults(batches, [], selectedMode);
                        } catch (e) {
                            console.error("Lỗi khi kéo thả:", e);
                        }
                    }
                });

                // Initial render
                renderDataTable();
            });
        </script>
    </body>
</html>
